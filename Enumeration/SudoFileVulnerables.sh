#!/bin/bash
#Colours
greenColour="\e[0;32m\033[1m"
endColour="\033[0m\e[0m"
redColour="\e[0;31m\033[1m"
blueColour="\e[0;34m\033[1m"
yellowColour="\e[0;33m\033[1m"
purpleColour="\e[0;35m\033[1m"
turquoiseColour="\e[0;36m\033[1m"
grayColour="\e[0;37m\033[1m"



function sudoers {
permiso=$(sudo -l | tail -n 1)
echo -e "\nSudo Entry: $permiso"

if [[ ! -z "$permiso" ]];
then
	if [[ "$permiso" = *'NOPASSWD'* ]];
	then
        	echo -e "${yellowColour}The user doesnt need the password to run as sudo${endColour}"
	fi

	if [ "$permiso" = "(ALL:ALL)ALL" ];
	then
       		echo "The user has full root permission $permiso  but needs to know the password"
	elif [[ "$permiso" = *"/"* ]];
	then
		binaries=($(echo $permiso | sed 's/(ALL:ALL)//g'| sed 's/,/ /g'))
		countBin=$(echo $permiso | sed 's/(ALL:ALL)//g'| sed 's/,/ /g' | wc -w)
		gtfo=($(curl -s 'https://gtfobins.github.io/#+sudo+shell' | grep '\".*/.*/#' -oh | sed 's/\// /g' | awk '{print $3}' | sort | uniq))
		countGtfo=$(curl -s 'https://gtfobins.github.io/#+sudo+shell' | grep '\".*/.*/#' -oh | sed 's/\// /g' | awk '{print $3}' | sort | uniq | wc -w) 
		vulnerablesBinPath=()
		vulnerablesBin=()

		
		for (( index=0; index<${#binaries[@]}; index++ ))
		do
			bin=$(echo ${binaries[$index]}  | sed 's/\//\n/g' | tail -1)
			
			url="https://gtfobins.github.io/gtfobins/$bin/"
			gtfo=$(curl -s $url | grep sudo)
			if [[ ! -z "$gtfo" ]]
			then
				vulnerablesBinPath+=("${binaries[$index]}")
				vulnerablesBin+=("$bin")
			fi
		done

		vulnerablesBinPathLength=${#vulnerablesBinPath[@]}
		
		if [[ $vulnerablesBinPathLength > 0 ]];
		then
			echo -e "${blueColour}--------------------------------------------------------------------------------------------------------------------"
			echo -e "|                                                                                                                  |"
			echo -e "|                 SUDO vulnerable binaries                                                                         |"
			echo -e "|                                                                                                                  |"
			echo -e "-------------------------------------------------------------------------------------------------------------------- "
			echo -e "|                   Binary            |        Exploit command                                                     |"
			echo -e "--------------------------------------------------------------------------------------------------------------------${endColour}"
			
			echo -e "${greenColour}--------------------------------------------------------------------------------------------------------------------"
			for (( index=0; index<$vulnerablesBinPathLength; index++  ))
			do
			echo "|		${vulnerablesBinPath[$index]}                https://gtfobins.github.io/gtfobins/${vulnerablesBin[$index]}/#sudo"
			echo "--------------------------------------------------------------------------------------------------------------------"
			done
		else
			echo -e "${greenColour}\n TEST OK: Binaries executed as sudo are not vulnerables${endColor}"
		fi
	else
		echo -e "${greenColour}\nSudoers pattern does not match. The sudo permission for this user are: \n $permiso${endColor}" 



	fi

else
        echo "The user has not special permission in sudoers."
fi
}


sudoers
