#! /bin/bash

# CIS Red Hat EL 8 Benchmark Section 4

#4.1.1.1-2
function isEnabled {

res=$(systemctl is-enabled auditd)

if [[ "$res" == "enabled" ]]; then
return true 
else
return false
fi

}


function  auditConfig {

if [[ isEnabled ]]; then
    size=$(grep "max_log_file" /etc/audit/auditd.conf | awk '{print $3}')
    keep=$(grep "max_log_file_action" /etc/audit/auditd.conf | awk '{print $3}')

    if [[ -z $size ]];then
    echo "Se debe configurar, max_log_file, el tamaño máximo (MB) del directorio de log"
    fi

    if [[ -z $keep ]];then
    echo "Se debe configurar, max_log_file_action en modo keep_logs"
    fi

fi

}

#4.1.3-
function  rules {

if [[ isEnabled ]]; then
    time=$(grep "time-change" /etc/audit/rules.d/audit.rules)
    identity=$(grep "identity" /etc/audit/rules.d/audit.rules)
    network=$(grep "system-locale" /etc/audit/rules.d/audit.rules)
    MAC=$(grep "MAC-policy" /etc/audit/rules.d/audit.rules)
    login=$(grep "login" /etc/audit/rules.d/audit.rules)
    sudo=$(grep "sudo.log" /etc/audit/rules.d/audit.rules)
    session=$(grep "session" /etc/audit/rules.d/audit.rules)
    filepermission=$(grep "perm_mod" /etc/audit/rules.d/audit.rules)
    access=$(grep "access" /etc/audit/rules.d/audit.rules)
    mounts=$(grep "mounts" /etc/audit/rules.d/audit.rules)
    delete=$(grep "delete" /etc/audit/rules.d/audit.rules)
    scope=$(grep "scope" /etc/audit/rules.d/audit.rules)
    actions=$(grep "scope" /etc/audit/rules.d/audit.rules)
    modules=$(grep "modules" /etc/audit/rules.d/audit.rules)
    immutable=$(grep "^\s*[^#]" /etc/audit/rules.d/audit.rules | tail -1)

    if [[ -z $time ]];then
    echo "Se debe configurar reglas para capturar eventos cuando la fehca y hora se modifica"
    fi

    if [[ -z $identity ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se modifican los ficheros group, passwd, shadow, gshadow y opasswd"
    fi

    if [[ -z $network ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se modifican ficheros de redes o llamadas al sistema que implica usar librerias de netoworking"
    fi

    if [[ -z $MAC ]];then
    echo "Se debe configurar reglas para capturar eventos cuando un usuario no autorizado intenta cambiar contextos de seguridad o los controles MAC"
    fi

    if [[ -z $login ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se producen intentos fallidos de autenticacion"
    fi

    if [[ -z $session ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se producen modificaciones en los ficheros que gestionan las sesiones"
    fi

    if [[ -z $filepermission ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se cambien los permisos de los ficheros"
    fi

    if [[ -z $access ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se intente acceder a ficheros sin exito"
    fi

    if [[ -z $mounts ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se use el comando mount"
    fi

    if [[ -z $delete ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se borren ficheros"
    fi

    if [[ -z $scope ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se use sudo desde el administrador del sistema"
    fi

    if [[ -z $actions ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se use sudo desde el administrador del sistema"
    fi

    if [[ -z $modules ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se añadan o eliminen modulos del sistema"
    fi

    if [[ -z $sudo ]];then
    echo "Se debe configurar reglas para capturar eventos cuando se ejecuten acciones como sudo"
    fi

    if [[ -z $immutable ]];then
    echo "Se debe configurar bloquear la modificacion de las reglas de audit. Se espera -e 2 al final del fichero audit.rules"
    fi
fi

}